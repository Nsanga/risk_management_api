name: D√©ploiement de l'API Server Express

on:
  push:
    branches: [main]

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    environment: production
    env:
      CI: false

    steps:
      - name: R√©cup√©rer le code du backend
        uses: actions/checkout@v3
        with:
          path: backend

      - name: V√©rifier la structure du d√©p√¥t apr√®s checkout
        run: |
          echo "==== Structure compl√®te apr√®s checkout ===="
          tree -L 3 backend || ls -R backend

      - name: Pr√©parer la structure du dossier sur le serveur
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "=== Pr√©paration du dossier serveur ==="
            sudo mkdir -p /var/www/backend/risk_management_api
            sudo chown -R $USER:$USER /var/www/backend/risk_management_api
            echo "=== Structure initiale sur le serveur ==="
            ls -la /var/www/backend/risk_management_api

      - name: V√©rification avant transfert SCP
        run: |
          echo "==== V√©rification avant transfert SCP ===="
          echo "Contenu de backend √† transf√©rer :"
          ls -la backend

      - name: Transf√©rer le code sur le serveur
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "backend/"  
          target: "/var/www/backend/risk_management_api"
          strip_components: 1 

      - name: V√©rification sur le serveur apr√®s transfert
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "=== Structure apr√®s transfert ==="
            ls -la /var/www/backend/risk_management_api

      - name: Cr√©er fichier .env sur le serveur
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "Cr√©ation du fichier .env"

            cat <<EOF > /var/www/backend/risk_management_api/.env
            DEFAULT_PASSWORD=${{ secrets.DEFAULT_PASSWORD }}
            URL_DB_LIVE=${{ secrets.URL_DB_LIVE }}
            URL_DB_LOCAL=${{ secrets.URL_DB_LIVE }}
            DB_NAME=${{ secrets.DB_NAME }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            NGROK_AUTHTOKEN=${{ secrets.NGROK_AUTHTOKEN }}
            EMAIL_USER=${{ secrets.SMTP_USERNAME }}
            EMAIL_PASS=${{ secrets.SMTP_PASSWORD }}

            CLOUDINARY_CLOUD_NAME=${{ vars.CLOUDINARY_CLOUD_NAME }}
            CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
            CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}

            EOF

            echo "Fichier .env cr√©√© avec succ√®s"
            cat /var/www/backend/risk_management_api/.env

      - name: D√©ployer l'API via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e
            cd /var/www/backend/risk_management_api
            
            echo "=== Installation des d√©pendances ==="
            if [ -f package-lock.json ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi
            
            echo "=== PM2 start/reload ==="
            pm2 reload risk_management_api --update-env || pm2 start index.js --name risk_management_api --update-env
            pm2 save
            
            sudo ss -lntp | grep :4500 || true
            pm2 ls


  notification:
    needs: deploy-api
    runs-on: ubuntu-latest
    environment: production
    if: always()
    steps:
      - name: Construire la liste des destinataires
        id: recipients
        run: |
          recipients="${{ vars.SMTP_TO }}"
          if [ -n "${{ vars.SMTP_TO_2 }}" ]; then
            recipients="$recipients, ${{ vars.SMTP_TO_2 }}"
          fi
          if [ -n "${{ vars.SMTP_TO_3 }}" ]; then
            recipients="$recipients, ${{ vars.SMTP_TO_3 }}"
          fi
          echo "allEmails=$recipients" >> $GITHUB_OUTPUT
          echo "Liste des destinataires : $recipients"

      - name: Envoyer email de succ√®s
        if: ${{ needs.deploy-api.result == 'success' && steps.recipients.outputs.allEmails != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          subject: "üéâ D√©ploiement de l'API r√©ussi !"
          body: "üöÄ Le d√©ploiement de l'API Server Express a √©t√© r√©alis√© avec succ√®s et PM2 a sauvegard√© la configuration. üëç"
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.SMTP_FROM }}
          to: ${{ steps.recipients.outputs.allEmails }}

      - name: Envoyer email d'√©chec
        if: ${{ needs.deploy-api.result == 'failure' && steps.recipients.outputs.allEmails != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          subject: "‚ùå D√©ploiement de l'API √©chou√© ‚ùå"
          body: "‚ö†Ô∏è Le d√©ploiement de l'API Server Express a √©chou√©. Veuillez v√©rifier les logs pour plus de d√©tails. üòû"
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.SMTP_FROM }}
          to: ${{ steps.recipients.outputs.allEmails }}

      - name: Aucune notification envoy√©e
        if: ${{ steps.recipients.outputs.allEmails == '' }}
        run: echo "Aucun destinataire d√©fini, aucun email n'a √©t√© envoy√©."
